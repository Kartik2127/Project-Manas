<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mentor Dashboard | Project Manas</title>
  <link rel="stylesheet" href="mentor_dashboard.css" />
</head>
<body>

  <header class="navbar">
    <div class="logo">Project Manas</div>
    <nav class="nav-links">
      <a href="mentor_dashboard.html" class="active">Dashboard</a>

      <a href="mentor_inbox.html" id="nav-inbox-link">
        Inbox
        <span id="inbox-count" class="inbox-badge" style="display: none;"></span>
      </a>

      <a href="#" onclick="goToProfile()">Profile</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>
  </header>

  <section class="dashboard">
    <div class="welcome-box">
      <h1 id="welcome-text">Welcome back, Mentor!</h1>
      <p class="motivation">
        “One kind word can change someone’s entire day.”
      </p>
      <p class="intro">
        As a mentor, your guidance can make a real difference in students’ lives.
        Explore the community, share your thoughts, and respond to those who seek help.
      </p>

      <div class="quick-links">
        <div class="card" onclick="scrollToForum()">
          <h3>Community Forum</h3>
          <p>View and respond to student posts</p>
        </div>

        <div class="card messages-card" onclick="goToInbox()">
          <h3>
            Messages
            <span id="msgBadge" class="badge-count" style="display:none;">0</span>
          </h3>
          <p>Check your private conversations</p>
        </div>

        <div class="card" onclick="goToProfile()">
          <h3>Profile</h3>
          <p>Edit your mentor details and visibility</p>
        </div>

      </div>
    </div>

    <div id="forum-section" class="forum-section">
      <h2>Community Forum</h2>
      <p class="subtitle">Reply to students or share your thoughts.</p>

      <div class="create-post">
        <form id="mentor-post-form">
          <textarea name="message" id="post-message" placeholder="Write something to inspire or guide students..." required></textarea>
          <button type="submit" class="btn-primary">Post</button>
        </form>
      </div>

      <hr />

      <div id="forum-posts" class="posts-container">
        <p>Loading posts...</p>
      </div>
    </div>
  </section>

  <footer class="footer">
    <p>© 2025 Project Manas • Empowering through empathy</p>
  </footer>

  <script>
    const username = localStorage.getItem("username") || localStorage.getItem("mentorEmail");
    const userType = localStorage.getItem("userType");
    const isLoggedIn = localStorage.getItem("isLoggedIn");

    if (!username) {
      alert("Session expired. Please login as a mentor again.");
      window.location.href = "login.html";
    }

    if (localStorage.getItem("username") && userType !== "mentor") {
       alert("Access denied. This area is for Mentors only.");
       window.location.href = "index.html";
    }

    const mentorEmail = username;

    if(mentorEmail) {
        document.getElementById("welcome-text").textContent = `Welcome back, ${mentorEmail.split('@')[0]}!`;
    }

    function scrollToForum() {
      document.getElementById("forum-section").scrollIntoView({ behavior: "smooth" });
    }

    function goToInbox() {
      window.location.href = "mentor_inbox.html";
    }

    function goToProfile() {
      window.location.href = "mentor_profile_edit.html";
    }

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    async function loadInboxBadge() {
      const navBadge = document.getElementById("inbox-count");
      const msgBadge = document.getElementById("msgBadge");

      try {
        const res = await fetch(`/chat/mentor/${mentorEmail}`);
        if(!res.ok) return; 
        const data = await res.json();

        let unreadTotal = 0;
        if (data.chats) {
          data.chats.forEach(c => {
            unreadTotal += c.unread_for_mentor || 0;
          });
        }

        if (navBadge) {
            navBadge.textContent = unreadTotal > 9 ? "9+" : unreadTotal;
            navBadge.style.display = unreadTotal > 0 ? "inline-flex" : "none";
        }
        if (msgBadge) {
            msgBadge.textContent = unreadTotal;
            msgBadge.style.display = unreadTotal > 0 ? "inline-block" : "none";
        }

      } catch (err) {
        console.log("Inbox check failed - server might be offline");
      }
    }

    document.getElementById("mentor-post-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const messageInput = document.getElementById("post-message");
      const message = messageInput.value.trim();

      if (!message) return;

      const formData = new FormData();
      formData.append("username", mentorEmail);
      formData.append("message", message);

      try {
        const res = await fetch("/forum/post", {
          method: "POST",
          body: formData
        });

        if (res.ok) {
          messageInput.value = "";
          fetchPosts();
        } else {
          alert("Failed to post message.");
        }
      } catch (err) {
        console.error(err);
      }
    });

    async function fetchPosts() {
      try {
        const res = await fetch("/forum/all");
        const data = await res.json();
        const postsDiv = document.getElementById("forum-posts");
        postsDiv.innerHTML = "";

        data.posts.forEach(post => {
            const postCard = document.createElement("div");
            postCard.className = "post-card";
            postCard.innerHTML = `
            <h4>
                ${post.username}
                ${post.type === "mentor" ? '<span class="badge">Mentor</span>' : ''}
            </h4>
            <p>${post.message}</p>
            <span>${new Date(post.timestamp).toLocaleString()}</span>
            <div class="reply-section">
                <textarea id="reply-${post._id}" placeholder="Write a reply..."></textarea>
                <button onclick="sendReply('${post._id}')">Reply</button>
            </div>
            <div id="replies-${post._id}" class="replies"></div>
            `;
            postsDiv.appendChild(postCard);
            fetchReplies(post._id);
        });
      } catch(err) {
          document.getElementById("forum-posts").innerHTML = "<p>Unable to load posts.</p>";
      }
    }

    async function sendReply(postId) {
      const replyBox = document.getElementById(`reply-${postId}`);
      const replyText = replyBox.value.trim();
      if (!replyText) return alert("Reply cannot be empty!");

      const formData = new FormData();
      formData.append("post_id", postId);
      formData.append("username", mentorEmail);
      formData.append("reply", replyText);

      await fetch("/forum/reply", {
        method: "POST",
        body: formData
      });

      replyBox.value = "";
      fetchReplies(postId);
    }

    async function fetchReplies(postId) {
      const res = await fetch(`/forum/replies/${postId}`);
      const data = await res.json();
      const repliesDiv = document.getElementById(`replies-${postId}`);
      repliesDiv.innerHTML = "";

      data.replies.forEach(r => {
        const div = document.createElement("div");
        div.className = `reply ${r.type === "mentor" ? 'mentor' : 'anonymous'}`;
        div.innerHTML = `
          <p>
            <strong>${r.username}</strong>
            ${r.type === "mentor" ? '<span class="badge">Mentor</span>' : ''} — 
            ${r.reply}
          </p>
          <span>${new Date(r.timestamp).toLocaleString()}</span>
        `;
        repliesDiv.appendChild(div);
      });
    }

    fetchPosts();
    loadInboxBadge();
    setInterval(loadInboxBadge, 5000);
  </script>
</body>
</html>