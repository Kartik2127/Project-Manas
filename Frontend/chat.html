<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat | Project Manas</title>
  <link rel="stylesheet" href="chat.css">
</head>
<body>

<header class="navbar">
  <div class="logo">Project Manas</div>
  <nav class="nav-links">
    <a href="inbox.html">Inbox</a>
    <a href="dashboard.html">Dashboard</a>
    <button onclick="logout()" class="logout-btn">Logout</button>
  </nav>
</header>

<section class="chat-section">
  <div class="chat-header">
    <h2 id="partnerName">Chat</h2>
  </div>

  <div id="messages" class="messages-box">
    <p class="loading">Loading chat...</p>
  </div>

  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</section>

<script>
/* ---------------------------------------
   LOAD USER INFO
----------------------------------------*/
const role = localStorage.getItem("role");
const student = localStorage.getItem("username");
const mentor = localStorage.getItem("mentorEmail");

let chatId = localStorage.getItem("currentChatId");
let partner = localStorage.getItem("chatPartner");

document.getElementById("partnerName").textContent = partner;

/* ---------------------------------------
   LOAD CHAT HISTORY
----------------------------------------*/
async function loadChat() {
  const msgBox = document.getElementById("messages");

  const res = await fetch(`http://127.0.0.1:8000/chat/${chatId}`);
  const data = await res.json();

  msgBox.innerHTML = "";

  data.messages.forEach(m => {
    const div = document.createElement("div");

    const isMine =
      (role === "student" && m.sender === student) ||
      (role === "mentor" && m.sender === mentor);

    div.className = isMine ? "msg msg-right" : "msg msg-left";

    div.innerHTML = `
      <p>${m.text}</p>
      <span>${new Date(m.timestamp).toLocaleTimeString()}</span>
    `;

    msgBox.appendChild(div);
  });

  msgBox.scrollTop = msgBox.scrollHeight;
}

/* ---------------------------------------
   SEND MESSAGE
----------------------------------------*/
async function sendMessage() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text) return;

  const sender = role === "student" ? student : mentor;

  const formData = new FormData();
  formData.append("chat_id", chatId);
  formData.append("sender", sender);
  formData.append("text", text);

  await fetch("http://127.0.0.1:8000/chat/send", {
    method: "POST",
    body: formData
  });

  input.value = "";
  loadChat();
}

/* ---------------------------------------
   REFRESH CHAT EVERY 1 SECOND
----------------------------------------*/
setInterval(loadChat, 1000);

/* ---------------------------------------
   LOGOUT
----------------------------------------*/
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

// Initial load
loadChat();
</script>

</body>
</html>
