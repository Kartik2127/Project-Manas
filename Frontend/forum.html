<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peer Support Forum | Project Manas</title>
  <link rel="stylesheet" href="forum.css" />
</head>
<body>

  <header class="navbar">
    <div class="logo">Project Manas</div>
    <nav class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="stories.html">Stories</a>
      <a href="chatbot.html">Chatbot</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>
  </header>

  <section class="forum-section">
    <h1>Peer Support Forum</h1>
    <p class="intro">Share your thoughts or experiences anonymously — you’re not alone</p>

    <form id="postForm">
      <input type="text" id="message" name="message" placeholder="Write something..." required />
      <button type="submit">Post</button>
    </form>

    <div id="postsContainer" class="posts-container"></div>
  </section>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      
      <div class="profile-avatar" id="mAvatar">A</div>
      <h2 id="mName">Name</h2>
      <p id="mRole" style="color:#1f7a8c; font-weight:600; margin-bottom:10px;">Role</p>
      
      <div style="text-align:left; margin-bottom:20px; color:#555; font-size:0.95rem;">
        <p><strong>Bio:</strong> <span id="mBio">...</span></p>
        <p><strong>College:</strong> <span id="mCollege">...</span></p>
        <p><strong>City:</strong> <span id="mCity">...</span></p>
      </div>

      <button id="mChatBtn" class="modal-btn">Start Private Chat</button>
    </div>
  </div>

  <script>
const username = localStorage.getItem("username") || "AnonymousUser";

async function loadPosts() {
  const res = await fetch("/forum/all");
  const data = await res.json();
  const container = document.getElementById("postsContainer");
  container.innerHTML = "";

  for (const post of data.posts) {
    const div = document.createElement("div");
    div.classList.add("post");
    
    let headerHtml = "";
    if (post.type === "mentor") {
        headerHtml = `
            <div class="post-header">
                <span class="mentor-link" onclick="fetchAndShowProfile('${post.username}')">
                    ${post.username.split('@')[0]}
                </span>
                <span class="badge">Mentor</span>
                <button class="chat-icon-btn" onclick="startChatWithMentor('${post.username}', '${post.username.split('@')[0]}')">
                    Chat
                </button>
            </div>
        `;
    } else {
        headerHtml = `<div class="post-header"><strong>${post.username}</strong></div>`;
    }

    const timeIST = new Date(post.timestamp).toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
    });

    div.innerHTML = `
      ${headerHtml}
      <p>${post.message}</p>
      <small style="color:#888;">${timeIST}</small>
      
      <div style="margin-top:8px;">
        <button class="reply-btn" onclick="toggleReplyBox('${post._id}')">Reply</button>
      </div>

      <div class="reply-box" id="reply-box-${post._id}" style="display:none;">
        <input type="text" id="reply-input-${post._id}" placeholder="Write a reply..." />
        <button onclick="sendReply('${post._id}')">Send</button>
      </div>
      
      <div class="replies" id="replies-${post._id}"></div>
    `;

    container.appendChild(div);
    loadReplies(post._id);
  }
}

async function loadReplies(post_id) {
  const res = await fetch(`/forum/replies/${post_id}`);
  const data = await res.json();
  const container = document.getElementById(`replies-${post_id}`);
  container.innerHTML = "";

  data.replies.forEach(r => {
    const replyDiv = document.createElement("div");
    replyDiv.classList.add("reply");
    
    const nameHtml = r.type === "mentor" 
        ? `<span class="mentor-link" onclick="fetchAndShowProfile('${r.username}')">${r.username.split('@')[0]}</span> <span class="badge">Mentor</span>`
        : `<strong>${r.username}</strong>`;

    const timeIST = new Date(r.timestamp).toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
    });

    replyDiv.innerHTML = `
      <p>${nameHtml} — ${r.reply}</p>
      <small>${timeIST}</small>
    `;
    container.appendChild(replyDiv);
  });
}

function toggleReplyBox(id) {
  const box = document.getElementById(`reply-box-${id}`);
  box.style.display = box.style.display === "none" ? "flex" : "none";
}

async function sendReply(post_id) {
  const input = document.getElementById(`reply-input-${post_id}`);
  const replyText = input.value.trim();
  if (!replyText) return;

  const formData = new FormData();
  formData.append("post_id", post_id);
  formData.append("username", username);
  formData.append("reply", replyText);

  await fetch("/forum/reply", {
    method: "POST",
    body: formData
  });

  input.value = "";
  loadReplies(post_id);
}

async function fetchAndShowProfile(email) {
  try {
    const res = await fetch(`/mentor/profile/${email}`);
    if(!res.ok) return alert("Could not load profile.");
    
    const m = await res.json();
    
    document.getElementById("mName").textContent = m.name || email.split('@')[0];
    document.getElementById("mAvatar").textContent = (m.name || email).charAt(0).toUpperCase();
    document.getElementById("mRole").textContent = m.occupation || "Peer Mentor";
    document.getElementById("mBio").textContent = m.bio || "No bio available";
    document.getElementById("mCollege").textContent = m.college || "Hidden";
    document.getElementById("mCity").textContent = m.city || "Hidden";

    const btn = document.getElementById("mChatBtn");
    btn.onclick = () => startChatWithMentor(email, m.name || email);

    document.getElementById("profileModal").classList.add("active");

  } catch(err) {
    console.error(err);
  }
}

function closeModal() {
  document.getElementById("profileModal").classList.remove("active");
}

window.onclick = function(e) {
  if(e.target == document.getElementById("profileModal")) closeModal();
}

async function startChatWithMentor(mentorEmail, mentorName) {
    const student = localStorage.getItem("username");
    if (!student || student === "AnonymousUser") {
        alert("You must be logged in to chat.");
        window.location.href = "login.html";
        return;
    }
    if (student === mentorEmail) {
        alert("You cannot chat with yourself!");
        return;
    }

    localStorage.setItem("role", "student");

    const formData = new FormData();
    formData.append("student_username", student);
    formData.append("mentor_email", mentorEmail);

    const res = await fetch("/chat/start", {
        method: "POST",
        body: formData
    });

    const data = await res.json();

    if (!data.chat_id) {
        alert("Error starting chat.");
        return;
    }

    localStorage.setItem("currentChatId", data.chat_id);
    localStorage.setItem("chatPartner", mentorName);

    window.location.href = "chat.html";
}

document.getElementById("postForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = document.getElementById("message").value;

  const formData = new FormData();
  formData.append("username", username);
  formData.append("message", message);

  await fetch("/forum/post", {
    method: "POST",
    body: formData
  });

  document.getElementById("message").value = "";
  loadPosts();
});

function logout() {
  localStorage.removeItem("username");
  window.location.href = "login.html";
}

loadPosts();
</script>

<script src="auth.js"></script>
</body>
</html>